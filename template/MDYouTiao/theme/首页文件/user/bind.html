<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<title>绑定{if condition="$ac eq 'phone'"}手机{else/}邮箱{/if} - 会员中心 - {$maccms.site_name}</title> 
		<meta name="keywords" content="会员中心,{$maccms.site_keywords}">
		<meta name="description" content="{$maccms.site_description}">
		{include file="system/include"}
		<link rel="stylesheet" type="text/css" href="{$maccms.path}MDassets/web/css/member.css">
		<link rel="stylesheet" type="text/css" href="{$maccms.path}MDassets/web/css/info.css">
	</head>
	<body>
		<div id="appSite" class="site reset-element">
			{include file="system/header"}
			<div class="main-contaner">
				<div class="middle middleContent">
					<div class="el-row">
						<div class="message">
							{include file="user/menu"}
							<div class="right-wrap">
								<div class="right-title">绑定{if condition="$ac eq 'phone'"}手机{else/}邮箱{/if}</div>
								<div class="right-router">
									<form class="updateInfo" id="fm" name="fm" method="post" action="">
										<input type="hidden" name="ac" value="{$ac}">
										<div class="content">
											<div style="text-align: center; margin: auto;margin-top: 150px;">
												<span>{if condition="$ac eq 'phone'"}手机号码{else/}邮箱地址{/if}：</span>
												<div class="capacha-input el-input el-input-group">
													<input type="text" name="to" autocomplete="off" placeholder="请输入{if condition="$ac eq 'phone'"}手机号码{else/}邮箱地址{/if}" value="" class="el-input__inner">
												</div>
												<button type="button" id="btn_bind_send" class="el-button capacha-button el-button--default btn_unbind" ac="email">
													<span>获取验证码</span>
												</button>
											</div>
										</div>
										<div class="content">
											<div style="text-align: center; margin: auto;">
											<span>验证码：</span>
											<div class="input-wrap el-input el-input-group">
												<input type="text" name="code" autocomplete="off" placeholder="请输入{if condition="$ac eq 'phone'"}手机{else/}邮箱{/if}验证码"  value="" class="el-input__inner">
											</div>
											</div>
										</div>
										<div style="text-align: center;margin-top: 0px;">
											<button type="button" id="btn_submit" class="saveBtn">确认绑定</button>
										</div>
									</form>
								</div>
							</div>
						</div>
					</div>
				</div>
				<script type="text/javascript">
					var countdown=60;
					function settime(val) {
						if (countdown == 0) {
							val.removeAttribute("disabled");
							val.value="获取验证码";
							countdown = 60;
							return true;
						} else {
							val.setAttribute("disabled", true);
							val.value="重新发送(" + countdown + ")";
							countdown--;
						}
						setTimeout(function() {settime(val) },1000)
					}

					$('#btn_bind_send').click(function(){
						var ac = $('input[name="ac"]').val();
						var to = $('input[name="to"]').val();
						if(ac=='email') {
							var pattern = /^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;
							var ex = pattern.test(to);
							if (!ex) {
								layer.msg('邮箱格式不正确');
								return;
							}
						}
						else if(ac=='phone') {
							var pattern=/^[1][0-9]{10}$/;
							var ex = pattern.test(to);
							if (!ex) {
								layer.msg('手机号格式不正确');
								return;
							}
						}
						else{
							layer.msg('参数错误');
							return;
						}


						settime(this);
						var data = $("#fm").serialize();

						$.ajax({
							url: "{:mac_url('user/bindmsg')}",
							type: "post",
							dataType: "json",
							data: data,
							beforeSend: function () {
								//开启loading
							},
							success: function (r) {
								layer.msg(r.msg);
							},
							complete: function () {
								//结束loading
							}
						});
					});

					$("#btn_submit").click(function() {
						var ac = $('input[name="ac"]').val();
						var to = $('input[name="to"]').val();

						if(ac=='email') {
							var pattern = /^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;
							var ex = pattern.test(to);
							if (!ex) {
								layer.msg('邮箱格式不正确');
								return;
							}
						}
						else if(ac=='phone') {
							var pattern=/^[1][0-9]{10}$/;
							var ex = pattern.test(to);
							if (!ex) {
								layer.msg('手机号格式不正确');
								return;
							}
						}
						else{
							layer.msg('参数错误');
							return;
						}

						var code = $('input[name="code"]').val();
						if(code==''){
							layer.msg('请输入验证码');
							return;
						}
						var data = $("#fm").serialize();

						$.ajax({
							url: "{:mac_url('user/bind')}",
							type: "post",
							dataType: "json",
							data: data,
							beforeSend: function () {
								//开启loading
								//$(".loading_box").css("display","block");
								$("#btn_submit").val("loading...");
							},
							success: function (r) {
								layer.msg(r.msg);
								if(r.code==1){
									location.href="{:mac_url('user/index')}";
								}
							},
							complete: function () {
								//结束loading
								//$(".loading_box").css("display","none");
								$("#btn_submit").val("提交");
							}
						});
					});
				</script>
				{include file="system/footer"}
			</div>
		</div>
	</body>
</html>
